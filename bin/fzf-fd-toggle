#!/usr/bin/env bash
# Wrapper script for fzf+fd that handles stateful toggles for --hidden and --no-ignore flags

set -euo pipefail

PANE_ID="$1"
TOGGLE_TYPE="$2"  # either "hidden" or "ignore"

STATE_FILE="/tmp/fzf-fd-state-${PANE_ID}"

# Initialize state if file doesn't exist
if [[ ! -f "$STATE_FILE" ]]; then
    echo "hidden=true" > "$STATE_FILE"
    echo "ignore=false" >> "$STATE_FILE"
fi

# Read current state
source "$STATE_FILE"

# Toggle the requested flag
if [[ "$TOGGLE_TYPE" == "hidden" ]]; then
    if [[ "$hidden" == "true" ]]; then
        hidden="false"
    else
        hidden="true"
    fi
elif [[ "$TOGGLE_TYPE" == "ignore" ]]; then
    if [[ "$ignore" == "true" ]]; then
        ignore="false"
    else
        ignore="true"
    fi
fi

# Save new state
echo "hidden=$hidden" > "$STATE_FILE"
echo "ignore=$ignore" >> "$STATE_FILE"

# Build fd command based on current state
FD_ARGS=(--type f)

if [[ "$hidden" == "true" ]]; then
    FD_ARGS+=(--hidden)
fi

if [[ "$ignore" == "true" ]]; then
    FD_ARGS+=(--no-ignore)
fi

# Execute fd and output the file list
exec fd "${FD_ARGS[@]}" --exclude .git --exclude node_modules
